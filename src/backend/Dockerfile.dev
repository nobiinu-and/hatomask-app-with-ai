FROM maven:3.9-eclipse-temurin-17

WORKDIR /app

# 依存を事前取得
COPY pom.xml ./
RUN mvn dependency:go-offline -B

# entr を使ってファイル変更を検知する
USER root
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
    entr \
    opencv-data \
    ca-certificates \
    curl \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    libice6 \
    libgomp1; \
    apt-get install -y --no-install-recommends libgtk2.0-0 \
    || apt-get install -y --no-install-recommends libgtk2.0-0t64; \
    rm -rf /var/lib/apt/lists/*

ENV HATOMASK_OPENCV_CASCADE_PATH=/usr/share/opencv4/haarcascades/haarcascade_frontalface_default.xml

RUN set -eux; \
    mkdir -p /opt/hatomask/models; \
    curl -fsSL -o /opt/hatomask/models/lbfmodel.yaml \
    https://raw.githubusercontent.com/kurnianggoro/GSOC2017/master/data/lbfmodel.yaml

ENV HATOMASK_OPENCV_LBF_MODEL_PATH=/opt/hatomask/models/lbfmodel.yaml

# ソースをコピー（開発時は compose でボリュームマウントする想定）
COPY . .

RUN chmod +x ./docker-entrypoint-dev.sh || true

EXPOSE 8080

CMD ["./docker-entrypoint-dev.sh"]
