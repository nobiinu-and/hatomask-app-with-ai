# データ取り扱い方針（実在写真・派生データ）

## 目的

HatoMask App が扱う「写真（実在人物を含みうる入力）」および、その派生データの**分類**と**取り扱いルール**を開発方針として定義します。

この方針は、実装（フロント/バック）、運用（ログ/監視）、テスト、AI 協働（Issue/PR/プロンプト）を含む開発活動全体に適用します。

## 適用範囲

- フロントエンド（ブラウザ）: 画像の読み込み、Canvas 合成、プレビュー、デバッグ表示
- バックエンド（API）: 画像の受信（multipart）、一時処理、レスポンス生成
- 監視/可観測性: アプリログ、例外通知、APM/トレース、RUM
- 開発支援: CI の成果物、テストデータ、Issue/PR、AI プロンプト・作業ログ

## 用語・定義

### Protected Photo Data（保護対象）

本プロジェクトの「実在写真」は **入力由来ベース** で定義します。

- ユーザーが端末から投入した **実写由来データ**（静止画、動画フレーム等）
- 上記から生成・抽出された **派生データ**（例: 切り抜き/サムネイル、Canvas 出力、合成途中の中間画像、顔ランドマーク、特徴量、バウンディングボックス、検出スコア、base64 文字列 等）

派生データも漏えい経路になりうるため、元画像と同等に保護対象として扱います。

### Non-Photo Operational Data（運用データ）

写真内容を含まない運用上のデータ。

- リクエスト ID（ランダム生成）
- 処理時間、HTTP ステータス
- 失敗種別（バリデーション/タイムアウト等）

## 現行方針（Milestone 0: Option B）

Milestone 0 では、技術検証のためサーバが Protected Photo Data を**受信する可能性**を許容します。
ただし、漏えいリスク最小化のため、次を **必須要件** とします。

### 1. 永続化禁止

サーバ/クライアントを問わず、Protected Photo Data を次へ保存してはいけません。

- DB、オブジェクトストレージ、ローカルディスク永続領域
- CDN、キャッシュ、バックアップ
- 監視/トレースの添付（リクエストボディ、breadcrumb 等）
- CI 成果物（スクリーンショット、ログ、添付ファイル等）

### 2. 短命 TTL（短時間のみ保持可）

- 保持が必要な場合でも **処理に必要な最短時間** に限定する
- 原則: **リクエストスコープ（メモリ内）**
- やむを得ず一時領域（テンポラリファイル等）を使う場合:
  - 最大 TTL は **5 分以内**（推奨: 1 分以内）
  - 正常系/例外系を問わず、処理完了時に **必ず削除** する

### 3. 非ログ（ログ/テレメトリに出さない）

Protected Photo Data を次へ出力してはいけません。

- アプリケーションログ（サーバ/クライアント）
- 例外送信（エラーログサービス、RUM 等）
- APM/トレース（リクエスト/レスポンスボディ添付 等）

加えて、入力ファイル名など **個人情報になりうる識別子** もログに出しません。

### 4. 最小限の運用ログのみ許可

許容されるのは Non-Photo Operational Data のみです。

- 許容例: `requestId`, `durationMs`, `status`, `errorCategory`
- 非許容例: `fileName`, `imageBase64`, `landmarks`, `thumbnail`, `debugImageUrl`

## 実装ガイド

### OpenAPI（契約）への反映

OpenAPI の `description` で、少なくとも次を明記します。

- 「保存しない（永続化禁止）」
- 「短命 TTL（必要最小限）」
- 「ログ/テレメトリに出さない（非ログ）」

関連: [docs/dev/OPENAPI_GUIDELINES.md](OPENAPI_GUIDELINES.md)

### バックエンド（Spring Boot）

- 画像を受信しても、ファイルを永続領域へ保存しない
- どうしてもテンポラリファイルが必要な処理は `try/finally` で削除する（例外時も同様）
- 例外ログは「リクエスト ID・エラー種別」中心にし、入力や派生物を含めない

### フロントエンド（React / ブラウザ）

- `console.log` 等へ base64 やランドマーク配列を出さない
- `localStorage` / `sessionStorage` へ画像（URL や base64 を含む）を保存しない
- 一時 URL（`URL.createObjectURL`）を使う場合は不要になったら `URL.revokeObjectURL` する

## テスト・デバッグ・AI 協働の注意

- E2E/テストデータは原則として **ダミー/合成画像** を使用する
- Issue/PR/プロンプト・作業ログへ Protected Photo Data（または派生データ）を貼り付けない
