# 機能仕様: マスク最小調整（静止画）

## 概要

自動配置された 3D ハトマスクがズレて見える場合に、ユーザーが最小限の操作で位置・スケール（必要に応じて回転）を微調整できるようにします。
Milestone 0 では「迷わない」「すぐ直せる」を優先し、調整項目は必要最小限に絞ります。

## スコープ

- 対象: 静止画
- 前提: 3D ハトマスクが表示され、自動配置が完了している
- 調整対象: 位置（X/Y）・スケール（拡大縮小）
- 位置調整は、マスクを直接ドラッグして行う
- （任意）回転（Z 軸/ロール相当）は、ズレが大きい場合にのみ導入を検討
- 出力: 調整後の 3D マスク変換（位置・スケール、必要なら回転）

スコープ外:

- 顔再検出アルゴリズムの改良（別の改善事項）
- 複数人の個別調整（Milestone 2）
- 高度な編集（メッシュ変形、パーツ調整、ライティング調整）

## 前提・依存

- 画像アップロードが完了し、プレビュー可能であること（`01_photo_upload`）
- 顔検出が成功していること（`02_face_detection_static`）
- 3D ハトマスクが表示されていること（`03_3d_mask_rendering`）
- 自動配置が完了していること（`04_mask_positioning`）

## ユースケース

### 基本フロー

1. ユーザーが自動配置された 3D ハトマスクを確認する
2. ズレていると感じた場合、調整 UI を開く
3. マスクをドラッグして位置（X/Y）を調整する
4. スライダーでスケール（拡大縮小）を調整する
5. 調整結果がプレビューにリアルタイム反映される
6. ユーザーは調整を確定し、保存（別 feature）へ進む

### 代替フロー

- 調整をやり直したい場合

  1. ユーザーは「リセット」で自動配置状態に戻せる

- 顔検出/自動配置が未完了の場合
  1. 調整 UI は無効、または開けない
  2. 必要な前提（顔検出の実行など）へ誘導する

## 機能要件

### 1. 調整 UI の提供

- 位置調整（X/Y）は、マスクを直接ドラッグして行える
- スケール調整を行う UI を提供する
- 調整 UI は「最小限で迷わない」構成とする
  - 例: ドラッグ操作（位置） + スケールスライダー

#### ドラッグ操作の要件

- ユーザーがマスクをドラッグすると、マスクが指/マウスの移動に追従して移動する
- ドラッグ中は「いま掴んでいる」ことが分かる状態になる（例: カーソル/ハイライト/つかみ判定）
- ドラッグ終了時、位置が確定される

### 2. リアルタイム反映

- 調整操作の結果が即座に 3D マスク表示へ反映される
- 調整中のカクつきが過度に目立たないこと

### 3. リセット

- 「リセット」で自動配置（調整前）状態に戻せる

### 4. 調整値の保持

- 同じ画像・同じ検出結果の間は、調整値を保持する
- 画像を差し替えた場合、調整値は初期化される
- 顔検出を再実行した場合、調整値は初期化される（自動配置を優先）

### 5. 調整の下限/上限

- スケールが極端に小さく/大きくなりすぎないよう、妥当な範囲を設ける
- 位置が画面外に飛びすぎないよう、妥当な範囲を設ける

## UI/UX 要件

### レイアウト（例）

```
+------------------------------------------+
|                HatoMask App              |
+------------------------------------------+
|  [写真プレビュー + 3Dマスク(ドラッグ可)]  |
|                                          |
|  [調整]                                  |
|  +------------------------------------+  |
|  |  位置: マスクをドラッグして調整     |  |
|  |  スケール: [---|-----] (数値)       |  |
|  |                                    |  |
|  |  [リセット]                         |  |
|  +------------------------------------+  |
|                                          |
|  [保存へ進む]（別feature）                |
+------------------------------------------+
```

### デザイン要件

- 既存の UI 方針に従い、Material-UI コンポーネントで構成する
- スライダーやボタンのラベルは簡潔にし、何が動くか分かる文言にする

### インタラクション要件

- スケール調整はキーボードでも可能（スライダーの標準操作）
- リセットは確認ダイアログ無しで即時反映（Milestone 0 は速度優先）

## 受け入れ基準 - Specification by Example

### Scenario: マスクをドラッグすると位置が変わる

```gherkin
Given ユーザーが自動配置された3Dハトマスクを表示している
When ユーザーが3Dハトマスクを右にドラッグする
Then 3Dハトマスクが右に移動して表示される
```

### Scenario: スケール調整でマスクの大きさが変わる

```gherkin
Given ユーザーが自動配置された3Dハトマスクを表示している
When ユーザーがスケールを大きく調整する
Then 3Dハトマスクが大きく表示される
```

### Scenario: リセットで自動配置状態に戻る

```gherkin
Given ユーザーがマスク位置とスケールを調整している
When ユーザーが「リセット」をクリックする
Then 3Dハトマスクが自動配置時の位置とスケールに戻る
```

### Scenario: 画像差し替えで調整値が初期化される

```gherkin
Given ユーザーがマスク調整を行っている
When ユーザーが別の画像を選択する
Then 調整値が初期化される
And 新しい画像に対して自動配置が適用される
```

### Scenario: 顔検出の再実行で調整値が初期化される

```gherkin
Given ユーザーがマスク調整を行っている
When ユーザーが顔検出を再実行する
Then 調整値が初期化される
And 新しい検出結果に基づく自動配置が適用される
```

## 非機能要件（必要に応じて）

### ユーザビリティ要件

- 初めてのユーザーでも、30 秒以内にズレを直せる操作量であること

## 技術的制約（必要に応じて）

- 実装は特定ライブラリに固定しない
- 3D レンダラー側の座標系と UI の値変換は一貫性を保つ

## 将来の拡張候補

- 回転（ロール）調整の追加
- ドラッグ操作の改善（スナップ、ガイド、より分かりやすいハンドル等）
- 調整プリセット（「少し上」「少し大きく」など）
