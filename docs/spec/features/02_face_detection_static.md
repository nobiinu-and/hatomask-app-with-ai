# 機能仕様: 静止画の顔検出（1 人）

## 概要

ユーザーがアップロードした静止画から、1 人分の顔ランドマーク（点群）と顔領域を検出し、後続の「3D ハトマスク描画」「マスク配置」に渡します。

## スコープ

- 対象: 静止画（写真アップロード機能で選択された画像）
- 検出対象: 1 人（写真内で最も大きく写っている顔）
- 出力: 顔ランドマーク（点群）および、顔領域（バウンディングボックス）

スコープ外:

- 複数人の同時検出（Milestone 2）
- リアルタイム（カメラ）追従（Milestone 1）
- 美化・フィルタ・表情演出

## 前提・依存

- 画像アップロードが完了し、プレビュー可能であること（例: feature [01_photo_upload](01_photo_upload.md)）
- バックエンド API で顔検出が実行できること（実装詳細は技術仕様 [face-detection-technical-spec](../architecture/face-detection-technical-spec.md) を参照）

※データ取り扱い方針は [data-handling](../../dev/policies/data-handling.md) に従う（実在写真・派生データは非ログ/非永続）。

## ユースケース

### 基本フロー

1. ユーザーが写真をアップロードし、プレビューが表示される
2. アプリが自動的に顔検出を実行する（または手動で「検出」ボタンをタップ）
3. 顔ランドマーク（点群）を検出し、プレビュー上に表示する
4. ユーザーが検出結果を確認できる
5. 検出結果が次の工程（3D マスク描画）に渡される

### 代替フロー

#### 顔が検出できない場合

1. アプリが「顔検出に失敗しました」というメッセージを表示する
2. ユーザーは以下のいずれかを選択できる：
   - 別の写真を選択する
   - 同じ写真で再度検出を試みる

#### 複数の顔が写っている場合

1. アプリは最も大きく写っている顔を自動的に選択する
   - 理由: 主要被写体は通常、写真内で最大の顔である
2. 選択された顔のみが検出対象になり、その顔のランドマークが表示される

## 機能要件

### 1. 入力画像の取り扱い

- 入力: ブラウザで選択可能で、バックエンドでも処理可能な画像（JPEG/PNG など）
- 画像の向き（EXIF 回転）が正しく反映された状態で検出する
  - プレビュー表示と顔検出の座標系が一致すること

### 2. 顔検出とランドマーク抽出

- 顔から以下の情報を自動検出し、返す：
  - **顔ランドマーク**: 顔上の複数点（点群）
  - **顔領域**: 顔全体を囲む矩形（検出された顔の位置・サイズ）

※ランドマークの点数や検出方式は、実装モードにより変わり得る（詳細は技術仕様 [face-detection-technical-spec](../architecture/face-detection-technical-spec.md) を参照）。

### 3. UI 表示

- 検出中: ローディング表示（例: スピナー）を表示する
- 検出成功: プレビュー上にランドマーク（点群）と顔領域を重ねて表示できる
- 検出失敗: ユーザーが次のアクションを選べるメッセージを表示する

### 4. デバッグ表示（Milestone 0 向け）

- 検出成功時、画像プレビュー上にランドマーク点（点群）を円またはマーカーで表示できる
- 顔領域（矩形）を表示することで、後続の 3D 配置調整に役立てられる
- データの永続化・外部送信は行わない（[data-handling](../../dev/policies/data-handling.md) に従う）

## UI/UX 要件

### レイアウト（例）

```
+------------------------------------------+
|                HatoMask App              |
+------------------------------------------+
|  [写真プレビュー]                         |
|  +------------------------------------+  |
|  |                                    |  |
|  |  画像 + (任意) ランドマーク表示     |  |
|  |                                    |  |
|  +------------------------------------+  |
|                                          |
|  状態: 検出中 / 成功 / 失敗              |
|  [再検出]  [別の写真を選ぶ]              |
+------------------------------------------+
```

### デザイン要件

- 既存の UI 方針に従い、Material-UI コンポーネントで構成する
- エラー/警告は既存の Alert 等で統一する

## 受け入れ基準 - Specification by Example

### Scenario: 写真から顔ランドマークと顔領域を表示できる

```gherkin
Given ユーザーが顔が写った写真をアップロードしてプレビューが表示されている
When アプリが顔検出を実行する
Then ランドマーク（点群）がプレビュー上に表示される
And 顔領域（矩形）も表示される
And 検出成功の状態が表示される
```

### Scenario: 複数の顔が写っている場合、主要被写体を検出する

```gherkin
Given ユーザーが複数の顔が写った写真をアップロードしてプレビューが表示されている
When アプリが顔検出を実行する
Then 最も大きく写っている顔のみが検出対象になる
And その顔のランドマーク（点群）が表示される
And 次の工程（3D マスク描画）に検出結果が渡される
```

### Scenario: 顔が検出できない場合、エラーメッセージが表示される

```gherkin
Given ユーザーが顔が写っていない（または検出困難な）写真をアップロードしてプレビューが表示されている
When アプリが顔検出を実行する
Then 「顔検出に失敗しました」というメッセージが表示される
And ユーザーが別の写真を選択できる
And ユーザーが再度検出を試みることができる
```

## 非機能要件（必要に応じて）

### パフォーマンス要件

- 一般的なスマートフォン/PC で、検出開始から結果表示までの待ち時間が過度に長くならないこと

## 技術的制約（必要に応じて）

- 外部 API への画像送信を必須にしない（M0 はローカル環境で完結する方式を優先）

## 将来の拡張候補

- 検出対象の複数人対応（Milestone 2）
- リアルタイム検出（Milestone 1）
- 検出結果の安定化（スムージング、顔の向き推定の高精度化）
