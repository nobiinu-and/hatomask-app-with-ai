# 機能仕様: 静止画の顔検出（1 人）

## 概要

ユーザーがアップロードした静止画から、1 人分の顔ランドマークを検出します。検出結果は後続の「3D ハトマスク描画」「マスク配置」の入力として利用します。

## スコープ

- 対象: 静止画（写真アップロード機能で選択された画像）
- 検出対象: 1 人（最も確度が高い 1 件）
- 出力: 顔ランドマーク（点群）および、後続処理で利用しやすい簡易情報（バウンディングボックス等）

スコープ外:

- 複数人の同時検出（Milestone 2）
- リアルタイム（カメラ）追従（Milestone 1）
- 美化・フィルタ・表情演出

## 前提・依存

- 画像アップロードが完了し、プレビュー可能であること（例: feature [01_photo_upload](01_photo_upload.md)）
- ブラウザ上で顔検出が実行できること（例: MediaPipe Face Mesh 等を想定）

※データ取り扱い方針は [data-handling](../../dev/policies/data-handling.md) に従う（実在写真・派生データは非ログ/非永続）。

## ユースケース

### 基本フロー

1. ユーザーが写真をアップロードし、プレビューが表示される
2. アプリが顔検出を実行する（自動または「検出」操作）
3. 1 人分の顔ランドマークを取得する
4. 検出結果を画面上で確認できる（デバッグ表示を含む）
5. 検出結果が次の工程（3D 描画/配置）に渡される

### 代替フロー

- 顔が検出できない場合

  1. アプリが「顔を検出できませんでした」を表示する
  2. ユーザーは別の写真を選択する、または再検出を実行できる

- 複数の顔が検出された場合
  1. アプリは最も確度が高い 1 件を採用する
  2. （任意）複数検出された旨を画面上のデバッグ表示に出す

## 機能要件

### 1. 入力画像の取り扱い

- 入力はブラウザでデコード可能な画像（JPEG/PNG 等）
- 画像の向き（EXIF 回転）が適切に反映された状態で検出を行う

### 2. 顔検出（静止画・1 人）

- 画像から顔ランドマークを推定し、1 人分を返す
- 返却するデータは次の情報を最低限含む
  - `landmarks`: 2D 座標の配列（正規化座標またはピクセル座標）
  - `boundingBox`: 顔領域の矩形（検出可の場合）
  - `confidence` または同等の信頼度指標（取得可能な場合）

### 3. 検出状態の UI 表示

- 検出中はローディング表示（例: スピナー）を表示する
- 検出成功時は「検出成功」が分かる状態を表示する
- 検出失敗時は、ユーザーが次の行動を選べるメッセージを表示する

### 4. デバッグ表示（Milestone 0 向け）

- 検出成功時、画像プレビュー上にランドマーク点（または輪郭）を重ねて表示できる
- デバッグ表示は後続の 3D 配置調整に役立つ最小限とする

#### 非ログ（M0）

- デバッグ用途であっても、ランドマーク等の派生データを**永続ログ**に出力しない
  - 画面上のオーバーレイ表示は許容するが、外部送信（エラーログサービス等）や保存は行わない

## UI/UX 要件

### レイアウト（例）

```
+------------------------------------------+
|                HatoMask App              |
+------------------------------------------+
|  [写真プレビュー]                         |
|  +------------------------------------+  |
|  |                                    |  |
|  |  画像 + (任意) ランドマーク表示     |  |
|  |                                    |  |
|  +------------------------------------+  |
|                                          |
|  状態: 検出中 / 成功 / 失敗              |
|  [再検出]  [別の写真を選ぶ]              |
+------------------------------------------+
```

### デザイン要件

- 既存の UI 方針に従い、Material-UI コンポーネントで構成する
- エラー/警告は既存の Alert 等で統一する

## 受け入れ基準 - Specification by Example

### Scenario: アップロード済み画像から顔ランドマークを取得できる

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
When アプリが静止画の顔検出を実行する
Then 1人分の顔ランドマークが取得できる
And 検出成功の状態が表示される
And プレビュー上にランドマークが重ねて表示される
```

### Scenario: 顔が検出できない場合にエラーが表示される

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And その写真に顔が写っていない
When アプリが静止画の顔検出を実行する
Then 顔を検出できない旨のメッセージが表示される
And ユーザーが再検出または別の写真選択を行える
```

### Scenario: 複数の顔が写っている場合は 1 人に絞って結果を返す

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And その写真に複数の顔が写っている
When アプリが静止画の顔検出を実行する
Then 1人分の顔ランドマークが取得できる
And 後続処理に渡す対象が1人に決定されている
```

## 非機能要件（必要に応じて）

### パフォーマンス要件

- 一般的なスマートフォン/PC で、検出開始から結果表示までの待ち時間が過度に長くならないこと

## 技術的制約（必要に応じて）

- ブラウザで実行可能な顔検出手段を利用する（外部 API への画像送信は必須にしない）

## 将来の拡張候補

- 検出対象の複数人対応（Milestone 2）
- リアルタイム検出（Milestone 1）
- 検出結果の安定化（スムージング、顔の向き推定の高精度化）
