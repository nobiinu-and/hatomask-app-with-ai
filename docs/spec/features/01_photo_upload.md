# 機能仕様: 写真アップロード（静止画）

## 概要

ユーザーがローカル端末から写真（静止画）を選択し、アプリ上でプレビューできるようにします。
この機能は後続の「静止画の顔検出（1 人）」や「3D ハトマスク適用」の入力となる“元画像”を用意することが目的です。

## スコープ

- 対象: 静止画（ローカルファイル選択）
- 対応形式: JPEG / PNG
- 主要機能: ファイル選択、バリデーション、画像デコード、プレビュー表示
- 出力: 後続機能が利用できる「選択済み画像」状態（画像データとメタ情報）

スコープ外:

- 画像のアップロード先サーバー永続化（Milestone 0 では必須にしない）
- 画像ダウンロード（無加工/加工後の保存は別 feature で扱う）
- ドラッグ&ドロップ
- 複数ファイル管理（履歴/ギャラリー）

## 用語

- **選択済み画像**: ユーザーが選び、アプリが「プレビュー可能」と判定した画像。
- **正規化画像**: 画像の向き（EXIF 回転など）を考慮し、アプリ内で一貫して扱える向きになった画像。

## データ取り扱い（Milestone 0: Option B）

本 feature が扱う「元画像」は、プロジェクトの定義する **実在写真（入力由来ベース）** に該当する可能性があります。
取り扱い方針は [data-handling](../../dev/policies/data-handling.md) に従います。

特に Milestone 0 では、サーバが画像を受信する可能性を許容しますが、以下を必須とします。

- **永続化禁止**: DB/ストレージ/キャッシュ/バックアップ等へ保存しない
- **短命 TTL**: 処理に必要な最短時間のみ保持（原則リクエストスコープ）
- **非ログ**: 画像データ/派生データ/入力ファイル名などをログ・テレメトリへ出さない

## ユースケース

### 基本フロー

1. ユーザーがアプリにアクセスする
2. ユーザーが「写真を選択」ボタンから画像ファイルを選択する
3. アプリが形式/サイズを検証する
4. アプリが画像をデコードし、プレビューを表示する
5. （次の操作として）ユーザーは顔検出を実行できる状態になる

### 代替フロー（必要に応じて）

- 非対応形式の場合
  1. アプリがエラーを表示し、画像は選択状態にならない
- サイズ超過の場合
  1. アプリがエラーを表示し、画像は選択状態にならない
- 画像のデコードに失敗した場合
  1. アプリがエラーを表示し、画像は選択状態にならない

## 機能要件

### 1. ファイル選択

- ユーザーはボタン操作でローカルの画像ファイルを選択できる
- 選択操作をキャンセルした場合、状態は変更されない

### 2. バリデーション

- 対応形式は JPEG / PNG とする
- 最大ファイルサイズは 10MB とする
- バリデーションに失敗した場合:
  - エラーメッセージを表示する
  - 「選択済み画像」は更新されない

### 3. 画像デコードと正規化

- バリデーション成功後、アプリは画像をデコードしてプレビュー可能にする
- 画像の向き（EXIF 回転など）により、プレビューと後続処理（顔検出）が一致するように扱う
  - 具体的な実装は問わないが、アプリ内で“見えている向き”と“検出に使う向き”が一致すること

### 4. プレビュー表示

- 選択済み画像が存在する場合、プレビューエリアに画像が表示される
- 表示は表示領域に収まるように調整され、アスペクト比は維持される

### 5. 後続機能への受け渡し

- 顔検出 feature が参照できる形で、以下の情報を保持する
  - 画像本体（デコード済み、または参照可能な形）
  - 画像サイズ（幅/高さ）
  - MIME type
- 新しい画像を選択した場合、後続処理の結果（顔検出結果・マスク状態など）は破棄/再計算の対象となる

## UI/UX 要件

### レイアウト

```
+------------------------------------------+
|                HatoMask App              |
+------------------------------------------+
|                                          |
|      [ 写真を選択 ]                      |
|                                          |
|  +------------------------------------+  |
|  |                                    |  |
|  |        プレビューエリア            |  |
|  |     (写真がない場合は案内文)       |  |
|  |                                    |  |
|  +------------------------------------+  |
|                                          |
|  [顔検出を実行]（画像選択後に有効）      |
|                                          |
+------------------------------------------+
```

### デザイン要件

- 既存の UI 方針に従い、Material-UI コンポーネントで構成する
- エラー/警告は既存の Alert 等で統一する

### インタラクション要件

- 「写真を選択」はキーボード操作でも実行できる
- バリデーションエラー時、何がダメだったかが分かるメッセージを表示する

## 受け入れ基準 - Specification by Example

### Scenario: JPEG ファイルを選択するとプレビューが表示される

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーがファイルサイズ5MBのJPEGファイルを選択する
Then プレビューエリアに選択した画像が表示される
And 「顔検出を実行」ボタンが有効になる
```

### Scenario: PNG ファイルを選択するとプレビューが表示される

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーがファイルサイズ3MBのPNGファイルを選択する
Then プレビューエリアに選択した画像が表示される
And 「顔検出を実行」ボタンが有効になる
```

### Scenario: ファイルサイズ超過の場合はエラーが表示される

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーがファイルサイズ11MBのJPEGファイルを選択する
Then エラーメッセージ「ファイルサイズは10MB以下にしてください」が表示される
And プレビューは表示されない
And 「顔検出を実行」ボタンは無効のままである
```

### Scenario: 非対応のファイル形式の場合はエラーが表示される

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーがGIF形式のファイルを選択する
Then エラーメッセージ「JPEG または PNG ファイルを選択してください」が表示される
And プレビューは表示されない
And 「顔検出を実行」ボタンは無効のままである
```

### Scenario: 2 回目の画像選択でプレビューが差し替わる

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーが別のPNG画像を選択する
Then プレビューエリアの画像が新しい画像に切り替わる
And 後続処理の状態（顔検出結果など）が新しい画像に対して未実行状態になる
```

## 将来の拡張候補

- ドラッグ&ドロップ対応
- ファイル情報の表示（ファイル名、サイズ、解像度）
- 画像のリサイズ/圧縮（端末負荷や処理速度の最適化）
- 画像のサーバー永続化（必要になったタイミングで別 feature 化）
