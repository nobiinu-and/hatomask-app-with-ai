# 機能仕様: 処理済み画像の保存（静止画）

## 概要

ユーザーが静止画プレビュー上で 3D ハトマスクの適用・調整を完了した後、合成済みの画像を端末に保存（ダウンロード）できるようにします。
共有は Milestone 1 以降で扱います。

※実在写真（入力由来ベース）および派生データの取り扱い方針は [data-handling](../../dev/policies/data-handling.md) に従います（M0: 受信 OK/非永続/短命 TTL/非ログ）。

## スコープ

- 対象: 静止画
- 入力:
  - 元画像（[01_photo_upload](01_photo_upload.md)）
  - 3D マスクの表示状態（[03_3d_mask_rendering](03_3d_mask_rendering.md)）
  - マスクの配置（[04_mask_positioning](04_mask_positioning.md)）および調整値（[05_mask_adjustment](05_mask_adjustment.md)）
- 出力:
  - 合成済み画像ファイル（ダウンロード）

スコープ外:

- 動画の録画・保存（Milestone 1 以降）
- 共有（Milestone 1 以降）
- サーバー保存・URL 発行（Milestone 0 では必須にしない）
- SNS 別の最適化（サイズテンプレ、透かし、投稿文生成など）

## 前提・依存

- 画像プレビューが表示されていること（[01_photo_upload](01_photo_upload.md)）
- 3D マスクが表示されていること（[03_3d_mask_rendering](03_3d_mask_rendering.md)）
- マスク配置・調整が反映済みであること（[04_mask_positioning](04_mask_positioning.md) / [05_mask_adjustment](05_mask_adjustment.md)）

## ユースケース

### 基本フロー

1. ユーザーが処理済みプレビュー（画像 + 3D マスク）を確認する
2. ユーザーが「保存」ボタンを押す
3. アプリが合成画像を生成する
4. 端末に画像がダウンロードされる

### 代替フロー（必要に応じて）

- 合成に失敗した場合
  1. アプリがエラーを表示する
  2. ユーザーが再試行できる

## 機能要件

### 1. 合成画像の生成

- 画面上で見えている「元画像 + 3D マスク」の見た目と一致する合成画像を生成する
- 合成後の画像は、少なくとも以下を満たす
  - 元画像が含まれている
  - 調整後の 3D マスクが反映されている

※生成方法（Canvas 合成、レンダラーの出力取得など）は実装に委ねるが、結果が一致すること。

### 2. 保存（ダウンロード）

- 「保存」ボタンで合成画像を端末にダウンロードできる
- ファイル形式は実装上扱いやすい形式（例: PNG）を基本とする
- ファイル名はユーザーが判別しやすい名前にする（例: `hatomask_YYYYMMDD_HHMMSS.png`）

### 3. 状態の UI 表示

- 合成/保存処理中はローディング表示を出す
- 失敗時はエラーメッセージを表示する
- 成功時はユーザーが成功を認識できるフィードバックを表示する（例: トースト/メッセージ）

## UI/UX 要件

### レイアウト（例）

```
+------------------------------------------+
|                HatoMask App              |
+------------------------------------------+
|  [写真プレビュー + 3Dマスク]              |
|                                          |
|  [調整]（別feature）                      |
|                                          |
|  [保存]                                   |
+------------------------------------------+
```

### デザイン要件

- 既存の UI 方針に従い、Material-UI コンポーネントで構成する
- 保存の導線は分かりやすく、迷わないラベルにする

## 受け入れ基準 - Specification by Example

### Scenario: 保存ボタンで合成画像をダウンロードできる

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 3Dハトマスクが表示され、配置と調整が反映されている
When ユーザーが「保存」ボタンをクリックする
Then 合成済み画像がダウンロードされる
And ダウンロードされた画像に3Dハトマスクが反映されている
```

### Scenario: 合成処理中はローディングが表示される

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 3Dハトマスクが表示されている
When ユーザーが「保存」ボタンをクリックする
Then 合成処理中のローディング表示が表示される
And 合成が完了したらローディング表示が消える
```

### Scenario: 合成に失敗した場合はエラーが表示される

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 3Dハトマスクが表示されている
When 合成画像の生成に失敗する
Then エラーメッセージが表示される
And ユーザーが再試行できる
```

## 非機能要件（必要に応じて）

### パフォーマンス要件

- 合成とダウンロードがユーザー体験を大きく阻害しない時間で完了すること

## 技術的制約（必要に応じて）

- 外部 API へ画像を送信する前提にしない（ローカル合成を基本）

## 将来の拡張候補

- 出力サイズのプリセット（SNS 向け比率）
- 透かし/クレジットのオンオフ
- サーバー保存 + 共有 URL 発行（必要になった時点で別 feature 化）
- 共有（Web Share 等、Milestone 1 以降）
