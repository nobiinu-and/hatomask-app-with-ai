# 機能仕様: マスク配置（静止画）

## 概要

静止画の顔検出結果を利用して、3D ハトマスクの位置・回転・スケールを“それっぽく”自動配置します。
Milestone 0 では「完全一致」ではなく、次の feature（最小調整）でユーザーが微調整できる前提で、初期配置の精度を確保します。

## スコープ

- 対象: 静止画（写真アップロード済み）
- 入力: 1 人分の顔ランドマーク（およびバウンディングボックス等）
- 出力: 3D マスクに適用する変換（位置・回転・スケール）
- 画面上で、初期配置がユーザーに確認できること

スコープ外:

- リアルタイム追従（Milestone 1）
- 複数人の配置（Milestone 2）
- 手動調整 UI（別 feature: [05_mask_adjustment](05_mask_adjustment.md)）
- モデル種類の切替、美化

## 前提・依存

- 画像アップロードが完了し、プレビュー可能であること（[01_photo_upload](01_photo_upload.md)）
- 静止画の顔検出が成功していること（[02_face_detection_static](02_face_detection_static.md)）
- 3D ハトマスクが描画可能であること（[03_3d_mask_rendering](03_3d_mask_rendering.md)）

## ユースケース

### 基本フロー

1. ユーザーが画像を選択してプレビューが表示される
2. 顔検出が成功し、1 人分のランドマークが得られる
3. アプリがランドマークから初期配置（位置・回転・スケール）を計算する
4. 3D ハトマスクが顔に対して適切な位置に配置される
5. ユーザーは（必要なら）次の工程で微調整できる

### 代替フロー

- 顔検出結果が不十分な場合
  1. アプリが「配置の計算に必要な情報が不足しています」を表示する
  2. 3D マスクは非表示、またはデフォルト位置で表示し、再検出を促す

## 機能要件

### 1. 初期配置の計算

- 顔検出結果から、以下を計算し 3D マスクに適用できる
  - 位置（X/Y）: 画像表示領域の座標系における配置
  - スケール: 顔サイズに対する相対スケール
  - 回転: 顔の向き（ヨー/ピッチ/ロール相当）

※座標系の定義（正規化/ピクセル、原点、上下左右）は実装で一貫していればよい。

### 2. 初期配置の品質（Milestone 0 基準）

- マスクが「顔から大きく外れて見えない」こと
- 少なくとも以下のケースで破綻しにくいこと
  - 正面顔
  - 軽い左右回転（ヨー）
  - 軽い上下傾き（ピッチ）
  - 軽い首かしげ（ロール）

### 3. 再計算のトリガー

- 次の場合に初期配置を再計算する
  - 画像を差し替えた
  - 顔検出を再実行した

### 4. 状態の UI 表示

- 配置計算中はローディング状態を表示できる
- 配置計算が失敗した場合、エラーメッセージを表示し、再検出等の次アクションが選べる

## UI/UX 要件

### インタラクション要件

- 配置の自動計算が完了したら、ユーザーが“次にやるべきこと”（例: 微調整 or 保存）へ進める導線を表示する

## 受け入れ基準 - Specification by Example

### Scenario: 顔検出結果に基づいて 3D マスクが初期配置される

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 静止画の顔検出が成功している
And 3Dハトマスクが表示可能である
When アプリがマスク配置を計算する
Then 3Dハトマスクが顔付近に配置されて表示される
And ユーザーが次の工程（微調整/保存）へ進める
```

### Scenario: 画像を差し替えると配置が再計算される

```gherkin
Given ユーザーが3Dハトマスクを表示している
When ユーザーが別の画像を選択する
Then プレビューが新しい画像に切り替わる
And 顔検出結果が新しい画像に対して取得される
And マスク配置が新しい画像に対して再計算される
```

### Scenario: 顔検出が失敗している場合は配置を行わない

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 静止画の顔検出が失敗している
When アプリがマスク配置を計算しようとする
Then 3Dハトマスクは配置されない
And 顔検出の再実行を促すメッセージが表示される
```

## 非機能要件（必要に応じて）

### パフォーマンス要件

- 配置計算はユーザー操作を阻害しない時間で完了すること（大きな画像でも過度に遅くならない）

## 技術的制約（必要に応じて）

- 実装は特定ライブラリに固定しない
- 外部 API へ画像を送信する前提にしない

## 将来の拡張候補

- 配置の安定化（推定の平滑化、外れ値処理）
- 顔の向き推定の精度向上
- 複数人配置（Milestone 2）
