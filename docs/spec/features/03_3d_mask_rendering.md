# 機能仕様: 3D ハトマスク描画（静止画）

## 概要

静止画プレビューの上に 3D ハトマスクを描画できるようにします。描画は「顔検出（静止画・1 人）」の結果を利用し、後続の「マスク配置」「最小調整」「画像保存」に繋がる土台を作ります。

## スコープ

- 対象: 静止画（写真アップロードで選択された画像）
- 3D 描画: 画像プレビュー上への 3D マスクのオーバーレイ表示
- 追従: 静止画のためリアルタイム追従は行わない（向き・位置は検出結果に基づき設定）
- 出力: レンダリング結果が画面に表示され、次工程（配置/調整/保存）で利用できる

スコープ外:

- リアルタイム（カメラ）追従（Milestone 1）
- 複数人の同時描画（Milestone 2）
- マスクの種類切替・ガチャ・美化
- 画像の保存（別 feature: [06_image_save](06_image_save.md) で扱う）

## 前提・依存

- 画像アップロードが完了し、プレビュー可能であること（[01_photo_upload](01_photo_upload.md)）
- 静止画の顔検出が完了していること（[02_face_detection_static](02_face_detection_static.md)）
- ブラウザで 3D レンダリングが可能であること（WebGL 等）

## ユースケース

### 基本フロー

1. ユーザーが画像を選択し、プレビューが表示される
2. アプリが静止画の顔検出を実行し、1 人分のランドマークを取得する
3. アプリが 3D ハトマスクの描画を初期化する
4. 画像プレビューの上に 3D ハトマスクが表示される
5. （次の操作として）ユーザーはマスク配置/調整を行える

### 代替フロー（必要に応じて）

- 3D の初期化に失敗した場合

  1. アプリが「3D 表示に失敗しました」を表示する
  2. ユーザーは 2D のみ（プレビュー/ランドマーク表示）で継続できる

- 顔検出結果がない/失敗している場合
  1. アプリは 3D マスクを表示しない
  2. ユーザーに顔検出の実行/再実行を促す

## 機能要件

### 1. レンダリング土台の提供

- 3D 描画領域（Canvas）を用意し、画像プレビュー上に重ねて表示できる
- 画像プレビューと 3D Canvas の座標系が一致する（同じ表示領域・同じ比率）

### 2. 3D ハトマスクの表示

- 3D ハトマスクが表示されること
- マスクは「顔がある位置」に出現すること（厳密な位置合わせは次 feature で扱う）

### 3. 検出結果の適用（最小）

- 顔検出結果（ランドマーク/バウンディングボックス等）を参照して、最低限の初期配置を行う
  - 位置: 顔領域付近
  - スケール: 顔領域サイズに応じた概算
  - 回転: 取得可能な範囲で概算（厳密化は次 feature）

### 4. 描画状態の UI 表示

- 3D 初期化中はローディング表示（例: スピナー）を表示する
- 3D 描画成功時は「表示中」が分かる状態を表示する
- 3D 描画失敗時は、エラーメッセージを表示し、ユーザーが次の行動を選べる

### 5. 再初期化の扱い

- ユーザーが別の画像を選択した場合、3D 表示は新しい画像に対して再初期化される
- 直前のマスク状態（位置/スケール等）は引き継がない（Milestone 0 では単純化）

## UI/UX 要件

### レイアウト（例）

```
+------------------------------------------+
|                HatoMask App              |
+------------------------------------------+
|  [写真プレビュー]                         |
|  +------------------------------------+  |
|  |  画像                               |  |
|  |  + 3Dマスク(Canvas)                 |  |
|  |  + (任意) ランドマーク表示           |  |
|  +------------------------------------+  |
|                                          |
|  状態: 顔検出 / 3D表示（成功/失敗）      |
|  [顔検出を実行]  [再表示]                |
+------------------------------------------+
```

### デザイン要件

- 既存の UI 方針に従い、Material-UI コンポーネントで構成する
- エラー/警告は既存の Alert 等で統一する

### インタラクション要件

- 3D 表示に必要な前提（画像選択・顔検出）が未完了の場合、ユーザーに次の操作が分かる導線を表示する

## 受け入れ基準 - Specification by Example

### Scenario: 顔検出完了後に 3D ハトマスクが表示される

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 静止画の顔検出が成功している
When アプリが3Dハトマスク描画を初期化する
Then プレビュー上に3Dハトマスクが表示される
And 3D表示が成功した状態が表示される
```

### Scenario: 顔検出が未実行のときは 3D ハトマスクを表示しない

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 静止画の顔検出が未実行である
When 3Dハトマスク表示を試みる
Then 3Dハトマスクは表示されない
And 顔検出の実行を促す案内が表示される
```

### Scenario: 3D 初期化に失敗した場合はエラーを表示し継続できる

```gherkin
Given ユーザーが写真をアップロードしてプレビューが表示されている
And 静止画の顔検出が成功している
When 3Dハトマスク描画の初期化に失敗する
Then エラーメッセージ「3D表示に失敗しました」が表示される
And ユーザーは別の写真を選択できる
```

### Scenario: 別の画像を選択すると 3D 表示が新しい画像に再初期化される

```gherkin
Given ユーザーが3Dハトマスクを表示している
When ユーザーが別の画像を選択する
Then プレビューが新しい画像に切り替わる
And 3Dハトマスク表示が新しい画像に対して再初期化される
```

## 非機能要件（必要に応じて）

### パフォーマンス要件

- 静止画のため、初期化コストがユーザー体験を大きく損ねないこと（必要なら遅延読み込みを検討）

### 互換性要件

- 最新の主要ブラウザ（Chrome/Firefox/Safari/Edge）で動作すること

## 技術的制約（必要に応じて）

- 3D 表示の具体的なライブラリは固定しない（例: Three.js を想定）
- 外部 API へ画像を送信する前提にしない

## 将来の拡張候補

- 3D マスクの品質向上（ライティング、影、質感）
- マスクの種類切替（Milestone 3）
- リアルタイム追従（Milestone 1）
