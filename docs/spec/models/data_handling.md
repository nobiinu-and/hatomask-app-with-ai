# ドメインモデル: データ取り扱い（写真・派生データ）

## 目的

本ドキュメントは、HatoMask App が扱う「写真（実在写真）」およびその派生データの**分類**と**取り扱いルール**を定義します。
特に Milestone 0（M0）では、実在写真を題材にした実装検討のため、サーバ受信を許容しつつも漏えいリスクを最小化する方針（Option B）を明文化します。

## 用語・定義

### 実在写真（入力由来ベース）

本プロジェクトにおける「実在写真」は、**入力由来ベース**で次のように定義します。

- ユーザーが端末から投入した**実写由来データ**（静止画・動画フレーム等）
- 上記から生成・抽出された**派生データ**（例: 切り抜き/サムネイル、Canvas 出力、合成途中の中間画像、顔ランドマーク、特徴量、バウンディングボックス、検出スコア等）

#### 採用理由（入力由来ベースを選ぶ理由）

- **漏えい経路を取りこぼしにくい**: 事故は「元画像」だけでなく、切り抜き・中間生成物・特徴量・ログなどから起きうるため、派生物も同じ保護対象に含めます。
- **仕様と実装の境界が明確**: 「この機能の入力と、その派生物は全部保護対象」という定義は、実装・レビュー・運用で判断がブレにくいです。
- **“識別可能性”判定の曖昧さを避ける**: “識別可能”は状況依存で議論が割れやすいため、M0 では保守的に入力由来を全て保護対象とします。

## データ分類

- **Protected Photo Data（保護対象）**: 実在写真（入力由来ベース）およびその派生データ
- **Non-Photo Operational Data（運用データ）**: リクエスト ID、処理時間、成功/失敗、エラー種別など（写真内容を含まないもの）

## Milestone 0 方針（Option B）

M0 では、サーバが実在写真を受信する可能性を認めます。ただし、次の制約を**必須要件**とします。

### 1. 永続化禁止

- サーバは Protected Photo Data を**永続化しない**
  - 例: DB、オブジェクトストレージ、ローカルストレージ、バックアップ、キャッシュ、CDN、監視/トレースの添付、CI 成果物 など

### 2. 短命 TTL（短時間のみ保持可）

- 保持が必要な場合でも、Protected Photo Data の保持は**処理に必要な最短時間**に限定する
- 原則: **リクエストスコープ（メモリ内）**
- やむを得ず一時領域を使う場合:
  - **最大 TTL は 5 分以内**（推奨: 1 分以内）
  - 処理完了時に即時削除し、例外時も必ず削除する

### 3. 非ログ（ログ/テレメトリに出さない）

- Protected Photo Data を次のいずれにも出力しない
  - アプリケーションログ（サーバ/クライアント）
  - 例外送信（例: エラーログサービス、RUM、Sentry 等）
  - APM/トレース（リクエストボディの添付、breadcrumb 等）
- 併せて、入力ファイル名など**個人情報になりうる識別子**もログに出さない

### 4. 最小限の運用ログ

- 許容されるのは Non-Photo Operational Data のみ
  - 例: リクエスト ID（ランダム生成）、処理時間、HTTP ステータス、失敗種別（バリデーション/タイムアウト等）

## 実装・仕様への反映ガイド

- 機能仕様書側は、各 feature で本ドキュメントを参照し、入力/派生データの取り扱いを明記する
- OpenAPI の `description` には「保存しない」「TTL」「ログしない」を含める（M0 の契約として明確化）
