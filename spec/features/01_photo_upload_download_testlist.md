# テストリスト: 写真のアップロードとダウンロード

## テストリストとは

このドキュメントは、Kent BeckのTest-Driven Development（TDD）で提唱されている「テストリスト」の形式で記述されています。

テストリストの目的:
- 実装前に必要なテストケースを洗い出す
- 実装中に頭の中のToDoを外部化し、今取り組むべきことに集中する
- 進捗を可視化する
- 新しいテストケースを思いついたら追加する（リストは成長する）

記号の意味:
- `[ ]` 未実装
- `[x]` 実装完了
- `[~]` スキップ（後回し）
- `[?]` 実装方法を検討中

---

## 受け入れ基準ベースのテストリスト

### Scenario 1: JPEGファイルのアップロードとダウンロード

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
  - [ ] ページのタイトルが「HatoMask App」である
  - [ ] ページが完全にロードされる（document.readyState === 'complete'）
  - [ ] コンソールにエラーが出力されていない
  - [ ] ページのレイアウトが崩れていない（基本的なスタイルが適用されている）
- **When** ユーザーが「写真を選択」ボタンをクリックする
  - [ ] 「写真を選択」ボタンが表示されている
  - [ ] 「写真を選択」ボタンが有効化されている（disabledでない）
  - [ ] ボタンをクリックするとファイル選択ダイアログが開く
  - [ ] ファイル選択ダイアログが開いた後もページがフリーズしない
- **And** ユーザーがファイルサイズ5MBのJPEGファイルを選択する
- **Then** アップロードが成功する
- **And** プレビューエリアに選択した画像が表示される
- **When** ユーザーが「ダウンロード」ボタンをクリックする
- **Then** 元の画像がダウンロードされる

### Scenario 2: PNGファイルのアップロードとダウンロード

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
- **When** ユーザーが「写真を選択」ボタンをクリックする
- **And** ユーザーがファイルサイズ3MBのPNGファイルを選択する
- **Then** アップロードが成功する
- **And** プレビューエリアに選択した画像が表示される
- **When** ユーザーが「ダウンロード」ボタンをクリックする
- **Then** 元の画像がダウンロードされる

### Scenario 3: 複数回の写真アップロード

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
- **When** ユーザーが1枚目のJPEGファイルをアップロードする
- **Then** 1枚目の画像がプレビューエリアに表示される
- **When** ユーザーが「写真を選択」ボタンをクリックする
- **And** ユーザーが2枚目のPNGファイルを選択する
- **Then** アップロードが成功する
- **And** プレビューエリアの画像が2枚目の画像に切り替わる

### Scenario 4: ファイルサイズ超過エラー

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
- **When** ユーザーがファイルサイズ11MBのJPEGファイルを選択する
- **Then** エラーメッセージ「ファイルサイズは10MB以下にしてください」が表示される
- **And** 画像はアップロードされない

### Scenario 5: 非対応のファイル形式エラー

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
- **When** ユーザーがGIF形式のファイルを選択する
- **Then** エラーメッセージ「JPEG または PNG ファイルを選択してください」が表示される
- **And** 画像はアップロードされない

### Scenario 6: 初期状態のUI確認

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
- **Then** 「写真を選択」ボタンが有効化されている
- **And** 「ダウンロード」ボタンが無効化されている
- **And** プレビューエリアが空の状態である

### Scenario 7: アップロード後のUI状態確認

- **Given** ユーザーがHatoMaskアプリケーションにアクセスしている
- **When** ユーザーが写真をアップロードする
- **Then** プレビューエリアに画像が表示される
- **And** 「ダウンロード」ボタンが有効化される

### Scenario 8: ブラウザ互換性テスト

- **Given** ユーザーが`<ブラウザ>`を使用している
- **When** ユーザーがHatoMaskアプリケーションにアクセスする
- **And** ユーザーがJPEGファイルをアップロードする
- **Then** ファイル選択が正常に動作する
- **And** アップロードが正常に動作する
- **And** プレビューが正常に表示される
- **And** ダウンロードが正常に動作する
- **Examples:** Chrome最新版、Firefox最新版、Safari最新版、Edge最新版

### Scenario 9: レスポンシブデザインテスト

- **Given** ユーザーが`<デバイス>`を使用している
- **And** 画面サイズが`<画面サイズ>`である
- **When** ユーザーがHatoMaskアプリケーションにアクセスする
- **And** ユーザーが写真をアップロードする
- **Then** レイアウトが適切に表示される
- **And** すべての機能が正常に動作する
- **Examples:** デスクトップ(1920x1080)、タブレット(768x1024)、モバイル(375x667)

---

## 実装の進め方

1. **まず Scenario 1 を完全に実装する**（Red-Green-Refactorを繰り返す）
2. 他のシナリオは差分実装で進める
3. 新しいテストケースを思いついたら随時追加する

---

## 環境セットアップ

### データベース
- [ ] PostgreSQLコンテナが起動する
- [ ] photosテーブルが存在する
- [ ] photosテーブルに必要なカラムが全て存在する（id, file_name, file_size, mime_type, file_path, created_at）

### ファイルストレージ
- [ ] uploads/photos/ディレクトリが存在する
- [ ] uploads/photos/ディレクトリに書き込み権限がある

### アプリケーション起動
- [ ] バックエンドが起動する（Spring Boot）
- [ ] フロントエンドが起動する（React）
- [ ] フロントエンドからバックエンドへの疎通確認（CORS設定）

## バックエンド: Photo エンティティとリポジトリ

### Photo エンティティ
- [ ] Photoエンティティクラスが存在する
- [ ] idフィールドがUUID型である
- [ ] fileNameフィールドが存在する
- [ ] fileSizeフィールドが存在する
- [ ] mimeTypeフィールドが存在する
- [ ] filePathフィールドが存在する
- [ ] createdAtフィールドが存在する

### PhotoRepository
- [ ] PhotoRepositoryインターフェースが存在する
- [ ] saveメソッドでPhotoを保存できる
- [ ] findByIdメソッドでPhotoを取得できる
- [ ] 存在しないIDで検索するとOptional.emptyが返る

## バックエンド: FileStorageService

### ファイル保存
- [ ] FileStorageServiceが存在する
- [ ] JPEGファイルを保存できる
- [ ] PNGファイルを保存できる
- [ ] 保存したファイルがuploads/photos/配下に存在する
- [ ] ファイル名がユニークである（UUID使用）
- [ ] 元のファイル拡張子が保持される

### ファイル取得
- [ ] 保存したファイルのパスを指定して取得できる
- [ ] 取得したファイルの内容が元のファイルと一致する
- [ ] 存在しないパスを指定すると例外がスローされる

## バックエンド: UploadPhotoUseCase

### 正常系
- [ ] JPEGファイルをアップロードできる
- [ ] PNGファイルをアップロードできる
- [ ] アップロード後、PhotoエンティティがDBに保存される
- [ ] アップロード後、ファイルがファイルシステムに保存される
- [ ] レスポンスにUUID形式のIDが含まれる
- [ ] レスポンスにファイル名が含まれる
- [ ] レスポンスにファイルサイズが含まれる
- [ ] レスポンスにMIMEタイプが含まれる
- [ ] レスポンスにISO 8601形式の作成日時が含まれる

### 異常系
- [ ] 10MBを超えるファイルをアップロードすると例外がスローされる
- [ ] JPEG/PNG以外のファイル（例: GIF）をアップロードすると例外がスローされる
- [ ] 空のファイルをアップロードすると例外がスローされる
- [ ] ファイル名が異常に長い場合でもエラーにならない（または適切にハンドリング）

## バックエンド: GetPhotoUseCase

### 正常系
- [ ] 保存済みの写真IDを指定して取得できる
- [ ] 取得した写真のバイト配列が正しい
- [ ] 取得した写真のMIMEタイプが正しい（JPEG: image/jpeg, PNG: image/png）

### 異常系
- [ ] 存在しないIDを指定すると例外がスローされる
- [ ] nullのIDを指定すると例外がスローされる
- [ ] ファイルがDBに存在するがファイルシステムから削除されている場合、例外がスローされる

## バックエンド: PhotoController

### POST /api/v1/photos
- [ ] エンドポイントが存在する
- [ ] multipart/form-dataを受け付ける
- [ ] 正常にアップロードすると200 OKが返る
- [ ] レスポンスボディがJSON形式である
- [ ] レスポンスにid, fileName, fileSize, mimeType, createdAtが含まれる

### POST /api/v1/photos - 異常系
- [ ] 10MB超過で400 Bad Requestが返る
- [ ] 非対応形式で400 Bad Requestが返る
- [ ] エラーレスポンスがRFC 9457形式である
- [ ] エラーレスポンスにtype, title, status, detailフィールドが含まれる

### GET /api/v1/photos/{id}
- [ ] エンドポイントが存在する
- [ ] 存在するIDで200 OKが返る
- [ ] Content-Typeヘッダーが正しい（image/jpeg または image/png）
- [ ] レスポンスボディが画像バイナリである
- [ ] レスポンスの画像が元の画像と一致する

### GET /api/v1/photos/{id} - 異常系
- [ ] 存在しないIDで404 Not Foundが返る
- [ ] 不正なUUID形式で400 Bad Requestが返る

## フロントエンド: ファイル選択機能

### UI要素
- [ ] 「写真を選択」ボタンが表示される
- [ ] ボタンをクリックするとファイル選択ダイアログが開く
- [ ] input要素のacceptがimage/jpeg,image/pngである

### バリデーション
- [ ] JPEG/PNG以外を選択するとエラーメッセージが表示される
- [ ] 10MB超のファイルを選択するとエラーメッセージが表示される
- [ ] エラーメッセージがアラートで表示される

## フロントエンド: アップロード機能

### API通信
- [ ] ファイル選択後、自動的にアップロードが開始される
- [ ] POST /api/v1/photosにリクエストが送信される
- [ ] Content-Typeがmultipart/form-dataである
- [ ] リクエストボディにfileフィールドが含まれる

### 状態管理
- [ ] アップロード成功後、写真IDがstateに保存される
- [ ] アップロード成功後、ファイル名がstateに保存される

### エラーハンドリング
- [ ] ネットワークエラー時にエラーメッセージが表示される
- [ ] 400エラー時にサーバーのエラーメッセージが表示される
- [ ] 500エラー時に汎用エラーメッセージが表示される

## フロントエンド: プレビュー表示機能

### UI要素
- [ ] プレビューエリアが存在する
- [ ] 初期状態でプレビューエリアは空である

### 画像表示
- [ ] アップロード成功後、自動的にプレビューが表示される
- [ ] GET /api/v1/photos/{id}から画像を取得する
- [ ] 画像がプレビューエリアに表示される
- [ ] 画像がプレビューエリアに収まるようにリサイズされる
- [ ] 画像のアスペクト比が維持される

### ローディング状態
- [ ] 画像読み込み中にローディング表示がある
- [ ] 画像読み込み完了後、ローディング表示が消える

### エラーハンドリング
- [ ] 画像取得失敗時にエラーメッセージが表示される
- [ ] 404エラー時に「写真が見つかりません」と表示される

## フロントエンド: ダウンロード機能

### UI要素
- [ ] 「ダウンロード」ボタンが存在する
- [ ] 初期状態でダウンロードボタンが無効化されている
- [ ] 写真アップロード後にダウンロードボタンが有効化される

### ダウンロード処理
- [ ] ダウンロードボタンクリックでGET /api/v1/photos/{id}が呼ばれる
- [ ] 取得した画像がダウンロードされる
- [ ] ダウンロードファイル名が適切である（元のファイル名またはphoto_{id}.jpg等）
- [ ] ブラウザの「名前を付けて保存」ダイアログが表示される

### エラーハンドリング
- [ ] ダウンロード失敗時にエラーメッセージが表示される

## E2Eテスト: 基本フロー

### JPEGファイルのアップロードとダウンロード
- [ ] アプリケーションにアクセスできる
- [ ] 「写真を選択」ボタンが表示されている
- [ ] 5MBのJPEGファイルを選択できる
- [ ] アップロードが成功する
- [ ] プレビューエリアに画像が表示される
- [ ] 「ダウンロード」ボタンが有効化される
- [ ] ダウンロードボタンをクリックできる
- [ ] 画像がダウンロードされる
- [ ] ダウンロードされた画像が元の画像と一致する

### PNGファイルのアップロードとダウンロード
- [ ] 3MBのPNGファイルを選択できる
- [ ] アップロードが成功する
- [ ] プレビューエリアに画像が表示される
- [ ] 画像がダウンロードされる

### 複数回のアップロード
- [ ] 1枚目の画像をアップロードできる
- [ ] 1枚目の画像がプレビュー表示される
- [ ] 2枚目の画像を選択できる
- [ ] 2枚目の画像がアップロードされる
- [ ] プレビューが2枚目の画像に切り替わる

## E2Eテスト: 異常系

### ファイルサイズ超過
- [ ] 11MBのJPEGファイルを選択する
- [ ] 「ファイルサイズは10MB以下にしてください」が表示される
- [ ] アップロードが実行されない

### 非対応ファイル形式
- [ ] GIF形式のファイルを選択する
- [ ] 「JPEG または PNG ファイルを選択してください」が表示される
- [ ] アップロードが実行されない

## E2Eテスト: UI状態

### 初期状態
- [ ] 「写真を選択」ボタンが有効である
- [ ] 「ダウンロード」ボタンが無効である
- [ ] プレビューエリアが空である

### アップロード後の状態
- [ ] 「写真を選択」ボタンが有効である
- [ ] 「ダウンロード」ボタンが有効である
- [ ] プレビューエリアに画像が表示されている

## E2Eテスト: ブラウザ互換性

- [ ] Chrome最新版で動作する
- [ ] Firefox最新版で動作する
- [ ] Safari最新版で動作する
- [ ] Edge最新版で動作する

## E2Eテスト: レスポンシブデザイン

- [ ] デスクトップ（1920x1080）で適切に表示される
- [ ] タブレット（768x1024）で適切に表示される
- [ ] モバイル（375x667）で適切に表示される

## 追加で思いついたテスト（随時追加）

<!-- 実装中に気づいたテストケースをここに追加する -->

## メモ・課題

<!-- 実装中の気づきや、後で対応すべき課題をメモする -->
