# 機能仕様: 写真のアップロードとダウンロード（最小実装版）

## 概要

最初のステップとして、ユーザーが写真をアップロードし、その写真をそのままダウンロードできる最小限の機能を実装します。  
この機能は、後続の顔検出やハトマスク適用機能の基盤となります。

## スコープ

**この仕様は最小実装に限定**します。フロントエンドとバックエンドの基本的な連携を実装します。

## ユースケース

### 基本フロー

1. ユーザーがWebアプリケーションにアクセス
2. ファイル選択ボタンから写真を選択
3. 選択した写真をバックエンドにアップロード
4. バックエンドから返されたIDを使ってプレビュー表示
5. ダウンロードボタンをクリック
6. バックエンドから写真を取得してダウンロード

## 機能要件

### 1. 写真アップロード

#### アップロード方法
- **ファイル選択のみ**: ボタンクリックでファイル選択ダイアログを表示

#### 対応ファイル形式
- JPEG (.jpg, .jpeg)
- PNG (.png)

#### ファイルサイズ制限
- 最大ファイルサイズ: 10MB

### 2. プレビュー表示

- アップロードした写真を画面上にプレビュー表示
- 画像は表示領域に収まるようにリサイズ（アスペクト比は維持）

### 3. ダウンロード機能

- 「ダウンロード」ボタンをクリックで写真をダウンロード
- アップロードした写真をそのまま（無加工で）ダウンロード
- 写真がアップロードされていない場合はボタンを無効化

## UI/UX要件

### レイアウト

```
+------------------------------------------+
|           HatoMask App                   |
+------------------------------------------+
|                                          |
|      [ 写真を選択 ]                      |
|                                          |
|  +------------------------------------+  |
|  |                                    |  |
|  |        プレビューエリア            |  |
|  |     (写真がない場合は空白)         |  |
|  |                                    |  |
|  +------------------------------------+  |
|                                          |
|           [ ダウンロード ]               |
|                                          |
+------------------------------------------+
```

### デザイン要件

- シンプルなレイアウト
- 基本的なスタイリング（中央揃え、適切な余白）

## 技術要件

### フロントエンド

#### 状態管理
- アップロードされた写真のID
- プレビューURL

### バックエンド

#### ファイルストレージ
- ローカルファイルシステムに保存
- 保存先ディレクトリ: `uploads/photos/`

#### API エンドポイント

##### POST /api/v1/photos
写真をアップロード

**リクエスト**
- Content-Type: `multipart/form-data`
- フィールド: `file` (画像ファイル)

**レスポンス**
```json
{
  "id": "string (UUID)",
  "fileName": "string",
  "fileSize": "number",
  "mimeType": "string",
  "createdAt": "string (ISO 8601)"
}
```

**エラーレスポンス** (RFC 9457 準拠)
```json
{
  "type": "about:blank",
  "title": "Bad Request",
  "status": 400,
  "detail": "File size exceeds maximum allowed size of 10MB"
}
```

##### GET /api/v1/photos/{id}
写真を取得

**レスポンス**
- Content-Type: `image/jpeg` または `image/png`
- Body: 画像バイナリデータ

**エラーレスポンス**
- 404 Not Found（写真が見つからない場合）

#### データモデル

**Photo テーブル**
```sql
CREATE TABLE photos (
  id UUID PRIMARY KEY,
  file_name VARCHAR(255) NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type VARCHAR(50) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### この機能で実装する層

- **Controller層**: PhotoController（アップロード・取得エンドポイント）
- **UseCase層**: UploadPhotoUseCase、GetPhotoUseCase
- **Repository層**: PhotoRepository
- **Infrastructure層**: FileStorageService

## エラーハンドリング

最小実装では、基本的なエラーメッセージをブラウザのアラートで表示します。

### エラーケース

| エラー | 発生場所 | メッセージ |
|--------|----------|-----------|
| 非対応のファイル形式 | フロントエンド | 「JPEG または PNG ファイルを選択してください」 |
| ファイルサイズ超過 | フロントエンド/バックエンド | 「ファイルサイズは10MB以下にしてください」 |
| アップロード失敗 | フロントエンド | 「アップロードに失敗しました。もう一度お試しください」 |
| 写真取得失敗 | フロントエンド | 「写真の取得に失敗しました」 |

## 実装手順

3つの主要機能に分けて段階的に実装します。各機能で動作確認を行いながら進めます。

### 機能1: アップロードができる

**目的**: ユーザーが写真を選択してバックエンドにアップロードできる

#### 環境セットアップ
1. Spring Boot プロジェクトの作成
2. React + TypeScript プロジェクトの作成
3. PostgreSQL データベースのセットアップ
4. ローカルファイルストレージ用ディレクトリの作成（`uploads/photos/`）
5. CORS設定

#### バックエンド実装
1. Photo エンティティの作成
2. Photo テーブルのマイグレーション作成・実行
3. PhotoRepository の実装
4. FileStorageService の実装（保存メソッド）
5. UploadPhotoUseCase の実装
6. PhotoController の POST /api/v1/photos エンドポイント実装
7. バリデーション（ファイル形式、サイズ）の実装
8. エラーハンドリング（RFC 9457準拠）の実装

#### フロントエンド実装
1. ファイル選択input要素の実装
2. ファイル選択ボタンのUI実装
3. バリデーション（ファイル形式、サイズ）の実装
4. POST /api/v1/photos へのAPIリクエスト実装
5. レスポンスの受け取りと写真IDの状態保存
6. エラーハンドリング（アラート表示）
7. 基本的なスタイリング

**動作確認**: 
- curlやPostmanでバックエンドAPIにアップロードできること
- フロントエンドから写真を選択してアップロードが成功すること
- アップロード後にコンソールで写真IDが確認できること

### 機能2: アップロードした画像が表示できる

**目的**: アップロードした写真をプレビュー表示できる

#### バックエンド実装
1. FileStorageService の実装（取得メソッド）
2. GetPhotoUseCase の実装
3. PhotoController の GET /api/v1/photos/{id} エンドポイント実装
4. Content-Typeの設定
5. エラーハンドリング（404 Not Found）の実装

#### フロントエンド実装
1. プレビューエリアのUI実装
2. GET /api/v1/photos/{id} へのAPIリクエスト実装
3. 取得した画像をプレビューエリアに表示
4. 画像のリサイズ（CSS）
5. ローディング状態の表示
6. プレビューエリアのスタイリング

**動作確認**:
- curlやブラウザでバックエンドAPIから画像を取得できること
- フロントエンドでアップロード後にプレビューが自動表示されること
- プレビューエリアに画像が正しく表示されること

### 機能3: ダウンロードができる

**目的**: プレビュー中の写真をダウンロードできる

#### フロントエンド実装
1. ダウンロードボタンのUI実装
2. ボタンの有効/無効状態の管理
3. GET /api/v1/photos/{id} から画像を取得
4. 画像をダウンロードする処理の実装
5. ダウンロードファイル名の設定
6. ダウンロードボタンのスタイリング

**動作確認**:
- 写真がアップロードされていない場合、ダウンロードボタンが無効化されていること
- 写真がアップロードされている場合、ダウンロードボタンが有効化されていること
- ダウンロードボタンをクリックして画像がダウンロードされること
- ダウンロードされたファイル名が正しいこと

### 最終確認: E2Eテスト

**目的**: 全機能が連携して正しく動作することを確認する

1. 基本フローのテストケース実行（JPEG、PNG）
2. 異常系のテストケース実行（サイズ超過、非対応形式）
3. 複数回アップロードのテスト
4. 複数ブラウザでの動作確認
5. レスポンシブ対応の確認

**確認**: すべてのテストケースが通ること

## 受け入れ基準 - Specification by Example

### Scenario: JPEGファイルのアップロードとダウンロード

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーがファイルサイズ5MBのJPEGファイルを選択する
Then アップロードが成功する
And プレビューエリアに選択した画像が表示される
When ユーザーが「ダウンロード」ボタンをクリックする
Then 元の画像がダウンロードされる
```

### Scenario: PNGファイルのアップロードとダウンロード

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーがファイルサイズ3MBのPNGファイルを選択する
Then アップロードが成功する
And プレビューエリアに選択した画像が表示される
When ユーザーが「ダウンロード」ボタンをクリックする
Then 元の画像がダウンロードされる
```

### Scenario: 複数回の写真アップロード

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが1枚目のJPEGファイルをアップロードする
Then 1枚目の画像がプレビューエリアに表示される
When ユーザーが「写真を選択」ボタンをクリックする
And ユーザーが2枚目のPNGファイルを選択する
Then アップロードが成功する
And プレビューエリアの画像が2枚目の画像に切り替わる
```

### Scenario: ファイルサイズ超過エラー

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーがファイルサイズ11MBのJPEGファイルを選択する
Then エラーメッセージ「ファイルサイズは10MB以下にしてください」が表示される
And 画像はアップロードされない
```

### Scenario: 非対応のファイル形式エラー

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーがGIF形式のファイルを選択する
Then エラーメッセージ「JPEG または PNG ファイルを選択してください」が表示される
And 画像はアップロードされない
```

### Scenario: 初期状態のUI確認

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
Then 「写真を選択」ボタンが有効化されている
And 「ダウンロード」ボタンが無効化されている
And プレビューエリアが空の状態である
```

### Scenario: アップロード後のUI状態確認

```gherkin
Given ユーザーがHatoMaskアプリケーションにアクセスしている
When ユーザーが写真をアップロードする
Then プレビューエリアに画像が表示される
And 「ダウンロード」ボタンが有効化される
```

### Scenario Outline: ブラウザ互換性テスト

```gherkin
Given ユーザーが<ブラウザ>を使用している
When ユーザーがHatoMaskアプリケーションにアクセスする
And ユーザーがJPEGファイルをアップロードする
Then ファイル選択が正常に動作する
And アップロードが正常に動作する
And プレビューが正常に表示される
And ダウンロードが正常に動作する

Examples:
  | ブラウザ | バージョン |
  | Chrome   | 最新版     |
  | Firefox  | 最新版     |
  | Safari   | 最新版     |
  | Edge     | 最新版     |
```

### Scenario Outline: レスポンシブデザインテスト

```gherkin
Given ユーザーが<デバイス>を使用している
And 画面サイズが<画面サイズ>である
When ユーザーがHatoMaskアプリケーションにアクセスする
And ユーザーが写真をアップロードする
Then レイアウトが適切に表示される
And すべての機能が正常に動作する

Examples:
  | デバイス     | 画面サイズ    |
  | デスクトップ | 1920x1080     |
  | タブレット   | 768x1024      |
  | モバイル     | 375x667       |
```

## 将来の拡張候補

- ドラッグ&ドロップ対応
- ファイル情報の表示（ファイル名、サイズ、解像度）
- エラーメッセージの改善（UI上での表示）
- クラウドストレージへの保存（AWS S3など）
- 画像の編集機能（ハトマスク適用）
- ユーザー認証とアクセス制御

````
